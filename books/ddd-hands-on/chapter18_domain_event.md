---
title: 'ドメインイベントの活用'
---

# ドメインイベントとは

**ドメインイベント**とは、ドメインで「過去に発生した出来事」のことです。この本ではすでにイベントストーミングの中でドメインイベントについて触れていました。おさらいすると、ドメインイベントを洗いだし、ドメインイベント同士をつなげることで、ビジネスプロセスやシステムの動作の全体像を明確に理解することができました。以下の図でオレンジ色の図形に記載されている内容がドメインイベントになります。

@[figma](https://www.figma.com/file/g04nAogGCGgM62IKXHUSLT/Online-bookstore?type=whiteboard&node-id=843-1791&t=hvtQJVFBGW90SwuN-0)

ドメインイベントはしばしば連鎖的な影響を及ぼします。たとえば、「書籍の在庫が切れた」というイベントが「書籍の発注イベント」や「在庫切れメール送信イベント」を引き起こします。それらのイベントがさらに新しいイベントを発生させる可能性もあります。このように、一つのイベントが次のイベントを誘発するプロセスを「**イベント駆動**」と呼びます。そして、イベント駆動を利用してシステムを設計する方法が「**イベント駆動型アーキテクチャ**」です。

イベント駆動型アーキテクチャでドメインイベントを適切に活用することにより、**イベントストーミングマップ内のプロセスをそのままシステム設計に反映させることができます**。ドメインイベントを、コードで具体的なイベントクラスやメソッドとして表現し、これらのイベントに基づいてシステムの各部分が相互に通信し合うことで、実現します。

## イベント駆動型アーキテクチャ (EDA)

イベント駆動型アーキテクチャは、システムの各コンポーネントが状態の変更や更新を示すイベントを発行、処理するアーキテクチャです。イベント駆動型アーキテクチャは、従来のリクエスト駆動型と異なり、システムの各コンポーネント間の疎結合を実現し、個にスケーリングさせることが容易になります。

イベント駆動型アーキテクチャのメリットとデメリットは以下の通りです。

|                  | 説明                                                                   |
| ---------------- | ---------------------------------------------------------------------- |
| **メリット**     |                                                                        |
| 疎結合           | コンポーネント間の依存関係が少なく、変更に強い。                       |
| スケーラビリティ | 各コンポーネントを独立してスケールアップ・ダウンできる。               |
| 柔軟性           | 新しいイベントやサービスを容易に統合できる。                           |
| 非同期処理       | システムの全体的なパフォーマンスを向上させる。                         |
| **デメリット**   |                                                                        |
| 複雑性           | イベントの管理や追跡が難しい場合がある。                               |
| デバッグの難しさ | イベントベースのシステムはデバッグが困難になることがある。             |
| データの整合性   | イベントが非同期であるため、データの整合性を保つのが難しい場合がある。 |

イベント駆動型アーキテクチャを利用する場合は、これらのメリットとデメリットを理解した上で、利用する必要があります。

イベント駆動型アーキテクチャでイベントを送信するモデルには、`Pub/Sub`モデル、`イベント・ストリーム`モデルなどがあります。ここでは`Pub/Sub`モデルを利用してドメインイベントを送信する方法を紹介します。

## Pub/Sub モデル

`Pub/Sub` (パブリッシュ/サブスクライブ) とは、アプリケーションのコンポーネント間でメッセージを非同期にやり取りする方法です。この方式では、メッセージを送る側 (パブリッシャー) が特定のトピックにメッセージを送信し、そのトピックを購読している側 (サブスクライバー) がメッセージを受け取ります。これにより、各サービスは他のサービスから独立しており、互いの動作に影響を与えずに情報を交換できます。

`Pub/Sub` メッセージングの主要な登場人物は以下の 4 つです。

- メッセージ
- トピック
- サブスクライバー
- パブリッシャー

それぞれの紹介とともに、`Pub/Sub` メッセージングをドメインイベントに適用する方法を確認していきましょう。

### メッセージ

メッセージは、送信者 (プロデューサー) から受信者 (コンシューマー) に送信される通信データです。メッセージのデータ型はさまざまですが、ドメインイベントでは JSON 形式のデータを利用します。JSON には、イベントの名前、発生した日時、発生時の集約の状態、およびその他の関連するデータが含まれます。

### トピック

すべてのメッセージは、特定のトピックに関連付けられています。トピックはメッセージのフィードを表す名前付きリソースで、送信者 (プロデューサー) と受信者 (コンシューマー) の間でメッセージをやり取りするための中間のチャネルのような役割を果たします。トピックには名前があり、メッセージを送信するときに指定する必要があります。このトピック名にドメインイベント名を利用します。たとえば「書籍の在庫が切れた」というドメインイベントの場合は`BookStockDepleted`のような名前にします。そして、そのトピックに関連するメッセージに興味がある受信者の一覧を管理しています。

### サブスクライバー

サブスクライバーはメッセージの受信者 (コンシューマー) です。サブスクライバーは、関心のあるトピックをサブスクライブする必要があります。サブスクライバーは、受信したメッセージを利用して、関連する処理を実行します。たとえば、「書籍の在庫が切れた」というドメインイベントのメッセージを受け取った場合は、書籍の発注を行う処理を実行します。

### パブリッシャー

パブリッシャーは、メッセージを送信するコンポーネントです。特定のドメインイベントが発生したとき、パブリッシャーはこのイベントに関連する情報を含むメッセージを作成します。たとえば「書籍の在庫が切れた」ドメインイベントの場合、パブリッシャーはこのメッセージを特定のトピック (`BookStockDepleted`) に公開し、トピックをサブスクライブしているすべてのサブスクライバーにイベントを通知します。パブリッシャーの役割は、ドメインイベントがシステム内の他のコンポーネントに伝わることを保証することです。このプロセスにより、イベント駆動の動作が可能となり、各コンポーネントが疎結合でありながら連携して動作することができます。

<!-- Pub/Sub メッセージングの実装には、`RabbitMQ`、`Apache Kafka`、`Amazon SNS`、`Azure Service Bus`、`Google Cloud Pub/Sub`などがあります。 -->

# ドメインイベントの実装

# ドメインイベントの活用

## 集約間の結果整合性を保つ

集約間の結果整合性について

## 非同期処理

メール送信などの非同期処理について。集約の保存と同期的に行う必要はない。

## コンテキスト間の統合

発行されたイベントを他のコンテキストに通知することで、コンテキスト間の統合を実現することができる。

## イベントソーシング

過去の状態を知りたいという要求に対して、イベントソーシングを活用することで、過去の状態を再現することができる。

### CQRS

クエリ用のテーブルをクエリの複雑な要件やパフォーマンスの向上のために利用する。

# OutBox パターン

イベントの保存と集約の保存の整合性を保つために、OutBox パターンを利用する。

# まとめ

### これまでのコード

# 参考文献

https://learn.microsoft.com/ja-jp/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/domain-events-design-implementation
https://kakehashi-dev.hatenablog.com/entry/2023/12/24/091000
https://techblog.zozo.com/entry/implementation-of-cqrs-using-outbox-and-cdc-with-dynamodb
https://aws.amazon.com/jp/what-is/pub-sub-messaging/
